<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/sub_layout.html}">
<body data-gnb-target="contact">
<div layout:fragment="content">

    <main class="sub qna-write">
        <div class="board board-type1">
            <div class="column">
                <h1>Q<span>&</span>A</h1>
                <p class="desc">
                    한화로보틱스에 대해 궁금한 점이<br />있으시면 문의해주세요.
                </p>
                <!--                <p class="desc" th:utext="#{notice}">-->
            </div>

            <div class="column board_list">

                <div class="qna-write-form">


                    <div class="qna-write-form-section">
                        <span class="qna-write-form-section-title">작성자</span>
                        <div class="qna-write-form-section-content">
                            <input class="qna-write-default-input" type="text" th:value="${qnaDetailEditResponse.getQnaDetail().getMemberId()}" name="name" id="memberId" readonly disabled/>
                        </div>
                    </div>


                    <div class="qna-write-form-section">
                        <span class="qna-write-form-section-title">이메일</span>
                        <div class="qna-write-form-section-content">
                            <input class="qna-write-custom-input" type="text" th:value="${qnaDetailEditResponse.getQnaDetail().getEmail()}" placeholder="이메일을 작성해주세요." name="email" id="email" />
                            <div class="qna-write-email-check">
                                <label class="checkbox-common">
                                    <input type="checkbox" id="emailReceiveYn" name="emailReceiveYn" style="appearance: auto" th:value="${qnaDetailEditResponse.getQnaDetail().getEmailReceiveYn()}"/>
                                    <span></span>
                                    <p>관리자가 답변을 남기면 이메일로 알림을 받습니다.</p>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="qna-write-form-section">
                        <span class="qna-write-form-section-title">문의유형 <strong>*</strong></span>
                        <div class="qna-write-form-section-content-wrapper">
                            <div class="qna-write-form-section-content qnaType1" id="qnaType1" th:text="${qnaDetailEditResponse.getQnaDetail().getQnaType1Nm()}">
                            </div>
                            <div class="qna-write-form-section-content">
                                <div class="qna-write-custom-radio qnaType2" id="qnaType2" th:text="${qnaDetailEditResponse.getQnaDetail().getQnaType1Nm()}"></div>
                            </div>
                        </div>
                    </div>

                    <div class="qna-write-form-section">
                        <span class="qna-write-form-section-title">문의제품 <strong>*</strong></span>
                        <div class="qna-write-inquiry-product">
                            <div class="qna-write-inquiry-product-title">
                                <p>모델명</p>
                                <p>로봇암 시리얼넘버</p>
                                <p>소프트웨어 버전</p>
                                <p>어플리케이션</p>
                                <p>추가/삭제</p>
                            </div>

                            <div class="qna-write-inquiry-product-box" >

                                <div class="qna-write-inquiry-product-item robotInfoContainer">

                                    <div id="modelCd" class="qna-write-inquiry-prodict-item-wrapper robotModel">
                                        <p>모델명</p>
                                    </div>

                                    <div class="qna-write-inquiry-prodict-item-wrapper">
                                        <p>로봇암 시리얼넘버</p>
                                        <input class="qna-write-custom-input serialNo" type="text" name="serial1" id="serial1" />
                                    </div>

                                    <div class="qna-write-inquiry-prodict-item-wrapper">
                                        <p>소프트웨어 버전</p>

                                        <div class="qna-write-software">
                                            <input class="qna-write-custom-input software" type="text" name="software1" id="software1" oninput="this.value = this.value.replace(/[^0-9]/g, '').substring(0, 1)" />
                                            <span>.</span>
                                            <input class="qna-write-custom-input software" type="text" name="software1" id="software2" oninput="this.value = this.value.replace(/[^0-9]/g, '').substring(0, 1)" />
                                            <input class="qna-write-custom-input software" type="text" name="software1" id="software3" oninput="this.value = this.value.replace(/[^0-9]/g, '').substring(0, 1)" />
                                            <input class="qna-write-custom-input software" type="text" name="software1" id="software4" oninput="this.value = this.value.replace(/[^0-9]/g, '').substring(0, 1)" />
                                            <span>.</span>
                                            <input class="qna-write-custom-input software" type="text" name="software1" id="software5" oninput="this.value = this.value.replace(/[^0-9]/g, '').substring(0, 1)" />
                                            <input class="qna-write-custom-input software" type="text" name="software1" id="software6" oninput="this.value = this.value.replace(/[^0-9]/g, '').substring(0, 1)" />
                                            <input class="qna-write-custom-input software" type="text" name="software1" id="software7" oninput="this.value = this.value.replace(/[^0-9]/g, '').substring(0, 1)" />
                                            <span>.</span>
                                            <input class="qna-write-custom-input software" type="text" name="software1" id="software8" oninput="this.value = this.value.replace(/[^0-9]/g, '').substring(0, 1)" />
                                            <input class="qna-write-custom-input software" type="text" name="software1" id="software9" oninput="this.value = this.value.replace(/[^0-9]/g, '').substring(0, 1)" />
                                            <input class="qna-write-custom-input software" type="text" name="software1" id="software10" oninput="this.value = this.value.replace(/[^0-9]/g, '').substring(0, 1)" />
                                        </div>
                                    </div>

                                    <div id="applicationCd" class="qna-write-inquiry-prodict-item-wrapper applicationCd">
                                        <p>어플리케이션</p>
                                    </div>

                                    <div class="qna-write-inquiry-product-item-btn">
                                        <button type="button" class="qna-write-inquiry-product-item-add" onclick="addRobotInfo()">
                                            <img src="/images/pc/ic_plus2.svg" alt="" />
                                        </button>
                                        <button type="button" class="qna-write-inquiry-product-item-delete" onclick="removeRobotInfo()">
                                            <img src="/images/pc/ic_minus.svg" alt="" />
                                        </button>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <div class="qna-write-form-section">
                        <span class="qna-write-form-section-title">제목 <strong>*</strong></span>
                        <div class="qna-write-form-section-content">
                            <input class="qna-write-custom-input full" type="text" name="title" id="title" th:value="${qnaDetailEditResponse.getQnaDetail().getTitle()}" />
                        </div>
                    </div>

                    <div class="qna-write-form-section">
                        <span class="qna-write-form-section-title">내용 <strong>*</strong></span>
                        <div class="qna-write-des-box">
                            <textarea class="qna-write-custom-textarea" name="description" id="content" th:text="${qnaDetailEditResponse.getQnaDetail().getContent()}"></textarea>
                            <span>문의 내용에 따라 제품 로그, 제품 구동 영상, <a href="/newsroom/notice"><strong>VOC 리포트</strong></a> 등을 추가로 요청할 수 있으며 메일을 통해 전달 부탁드립니다.</span>
                        </div>
                    </div>

                    <div class="qna-write-form-section">
                        <span class="qna-write-form-section-title">첨부파일</span>
                        <div class="qna-write-form-file-wrapper">
                            <div class="qna-write-custom-file">
                                <input type="file" name="file" id="fileInput" onchange="handleFileUpload()"/>
                                <label for="fileInput">파일찾기</label>
                            </div>
                            <div class="qna-write-file-list">
                                <div class="qna-write-file-list-item">
                                    <span class="serverFileDisplayContainer">
                                        <th:block th:each="file, fileIndex : ${qnaDetailEditResponse.qnaFiles}">
                                            <span th:text="${file.originalFileNm}" th:data-file-no="${file.fileNo}"></span>
                                            <button type="button" onclick="addDeleteList(this)">
                                                <img src="/images/pc/btn_close.svg" alt="" />
                                            </button>
                                        </th:block>
                                    </span>
                                </div>
                            </div>
                            <span>첨부파일 개당 최대 5MB 이내, 최대 5개까지 첨부 가능합니다. exe, html 형식등 문제가 될 수 있는 파일은 압축파일 형태로 첨부해주세요.</span>
                        </div>
                    </div>

                </div>

                <button type="button" class="qna-write-submit" onclick="editConfirm()">수정하기</button>

            </div>
        </div>
    </main>
</div>

</body>


<th:block layout:fragment="script">
    <script>

        document.addEventListener("DOMContentLoaded", function() {
            const existingSoftwareInputs = document.querySelectorAll('.qna-write-custom-input.software');

            existingSoftwareInputs.forEach((input, index) => {
                if (index === existingSoftwareInputs.length - 1) return;
                input.addEventListener('input', function() {
                    if (this.value.length > 0) {
                        existingSoftwareInputs[index + 1].focus();
                    }
                });
            });
        });

        const qnaType1Nm = "[[${qnaDetailEditResponse.getQnaDetail().getQnaType1Nm()}]]";
        const qnaType2Nm = "[[${qnaDetailEditResponse.getQnaDetail().getQnaType2Nm()}]]";

        const paths = window.location.pathname.split('/');

        const formData = new FormData();

        $(document).ready(function () {
            getCode();
            getEditCode();

            const emailReceiveYn = $('#emailReceiveYn').val();
            if (emailReceiveYn === 'Y') {
                $('#emailReceiveYn').prop('checked', true);
            }
            else {
                $('#emailReceiveYn').prop('checked', false);
            }

            $('#emailReceiveYn').change(function() {
                if ($(this).is(':checked')) {
                    $('#emailReceiveYn').val('Y');
                } else {
                    $('#emailReceiveYn').val('N');
                }
            });
        });



        // 문의유형 코드 가져오기
        function getCode() {
            COMM.ajax({
                type: 'GET',
                url: "/qna/code",
                success: function (data) {
                    populateSelectBox(data.data.qnaType1List, 'qnaType1');
                    populateRadioButtons(data.data.qnaType2List, 'qnaType2');
                },
            });
        }


        // 문의유형 1
        function populateSelectBox(options, selectClass) {
            const selectBox = $('<select class="qna-write-custom-select">');
            selectBox.addClass(selectClass);

            $.each(options, function (index, option) {
                const optionElement = $('<option>', {
                    value: option.code,
                    text: option.description
                });
                if (option.code === qnaType1Nm) {
                    optionElement.prop('selected', true);
                }
                selectBox.append(optionElement);
            });

            $('.' + selectClass).html(selectBox);
        }

        // 문의유형 2
        function populateRadioButtons(options, containerId) {
            const container = $('#' + containerId);
            container.empty();

            $.each(options, function (index, option) {

                const label = $('<label>', {
                    class: 'radio'
                })
                const radioBtn = $('<input>', {
                    type: 'radio',
                    name: 'qnaType2',
                    value: option.code
                });

                if (option.code === qnaType2Nm) {
                    radioBtn.prop('checked', true);
                }

                const span = $('<span>',{
                });

                const p = $('<p>', {
                    // for: option.code,
                    text: option.description
                });

                label.append(radioBtn).append(span).append(p);
                container.append(label);
            });
        }


        // 문의제품 정보 불러오기
        function getEditCode() {
            COMM.ajax({
                type: 'GET',
                url: "/qna/code/" + paths[paths.length-1],
                success: function (data) {
                    populateSelectAndInputs(data.qnaCodeResponse.robotModelList, 'robotModel');
                    populateSelectAndInputsApp(data.qnaCodeResponse.applicationList, 'applicationCd');

                    const qnaRobots = data.qnaDetailEditResponse.qnaRobots;
                    const robotInfoContainer = $('.robotInfoContainer');

                    // 기존에 존재하는 로봇 정보 개수
                    const existingRobotInfoCount = robotInfoContainer.length;

                    // 불러온 로봇 정보의 개수에 따라 기본 로봇 정보의 개수 결정
                    const defaultRobotInfoCount = qnaRobots.length > 0 ? qnaRobots.length : 1;

                    // 불러온 로봇 정보가 없는 경우, 기존의 로봇 정보를 모두 삭제
                    if (qnaRobots.length === 0) {
                        robotInfoContainer.remove();
                    }

                    // 기본 로봇 정보를 추가
                    for (let i = existingRobotInfoCount; i < defaultRobotInfoCount; i++) {
                        const newRobotInfo = $('.robotInfoContainer:first').clone();
                        robotInfoContainer.last().after(newRobotInfo);
                    }

                    // 불러온 로봇 정보를 추가
                    qnaRobots.forEach(function(robot, index) {
                        const currentRobotInfoContainer = $('.robotInfoContainer').eq(index);
                        currentRobotInfoContainer.find('.robotModel select').val(robot.modelCd);
                        currentRobotInfoContainer.find('.serialNo').val(robot.serialNo);


                        const swVersion = robot.swVersion;
                        const parts = swVersion.split('.');
                        const splitParts = parts.map(part => part.split(''));

                        // currentRobotInfoContainer.find('.swVersion').val(robot.swVersion);
                        currentRobotInfoContainer.find('#software1').val(splitParts[0]);
                        currentRobotInfoContainer.find('#software2').val(splitParts[1][0]);
                        currentRobotInfoContainer.find('#software3').val(splitParts[1][1]);
                        currentRobotInfoContainer.find('#software4').val(splitParts[1][2]);
                        currentRobotInfoContainer.find('#software5').val(splitParts[2][0]);
                        currentRobotInfoContainer.find('#software6').val(splitParts[2][1]);
                        currentRobotInfoContainer.find('#software7').val(splitParts[2][2]);
                        currentRobotInfoContainer.find('#software8').val(splitParts[3][0]);
                        currentRobotInfoContainer.find('#software9').val(splitParts[3][1]);
                        currentRobotInfoContainer.find('#software10').val(splitParts[3][2]);


                        // currentRobotInfoContainer.find('.applicationCd select').val(robot.applicationCd);
                        currentRobotInfoContainer.find('.applicationCd option').filter(function() {
                            return $(this).text() === robot.applicationCd;
                        }).prop('selected', true);

                    });
                },
            });
        }



        // 문의제품 - 모델명
        function populateSelectAndInputs(options, containerId) {
            const container = $('.' + containerId);
            container.empty();

            const selectBox = $('<select class="qna-write-custom-select" name="inquiry2" id="inquiry2">');
            container.append(selectBox);

            // selectBox.append($('<option>', {
            //     value: '',
            //     text: '선택'
            // }));

            $.each(options, function (index, option) {
                selectBox.append($('<option>', {
                    value: option.code,
                    text: option.description
                }));
            });
        }


        // 문의제품 - 어플리케이션
        function populateSelectAndInputsApp(options, containerId) {
            const container = $('.' + containerId);
            container.empty();

            const selectBox = $('<select class="qna-write-custom-select app" name="inquiry3" id="inquiry3">');
            container.append(selectBox);

            // selectBox.append($('<option>', {
            //     value: '',
            //     text: '선택'
            // }));

            $.each(options, function (index, option) {
                selectBox.append($('<option>', {
                    value: option.code,
                    text: option.description
                }));
            });
        }


        // FIXME : 기존에 불러온 데이터가 있을때도 처음부터 - 로 삭제 가능하도록 (1개는 남겨야함)
        // 문의제품 영역 추가 삭제
        let robotInfoCounter = 1;

        // function addRobotInfo() {
        //     if (robotInfoCounter < 10) {
        //         const newRobotInfo = $('.robotInfoContainer:first').clone();
        //         newRobotInfo.find('input').val('');
        //         $('.robotInfoContainer:last').after(newRobotInfo);
        //         robotInfoCounter = $('.robotInfoContainer').length;
        //     }
        // }

        // function removeRobotInfo() {
        //     if (robotInfoCounter > 1) {
        //         $('.robotInfoContainer:last').remove();
        //         robotInfoCounter = $('.robotInfoContainer').length;
        //     }
        // }

        function removeRobotInfo() {
            if ($('.robotInfoContainer').length > 1) {
                $('.robotInfoContainer:last').remove();
                robotInfoCounter = $('.robotInfoContainer').length;
            }
        }


        function addRobotInfo() {
            if (robotInfoCounter < 10) {
                const newRobotInfo = $('.robotInfoContainer:first').clone();
                newRobotInfo.find('input').val('');
                $('.robotInfoContainer:last').after(newRobotInfo);
                robotInfoCounter = $('.robotInfoContainer').length;

                const newInputs = newRobotInfo.find('.qna-write-custom-input.software');
                for (let i = 0; i < newInputs.length; i++) {
                    newInputs[i].addEventListener('input', function() {
                        if (this.value.length >= 1 && i < newInputs.length - 1) {
                            newInputs[i + 1].focus();
                        }
                    });
                }

            } else {
                alert('최대 10개까지만 추가할 수 있습니다.');
            }
        }


        // 기존 파일 정보를 불러와서 fileList에 추가
        var fileList = []; // 파일 목록을 저장할 배열

        $(document).ready(function() {
            // 기존 파일 정보를 불러와서 fileList에 추가
            const existingFiles = $('.serverFileDisplayContainer span');

            existingFiles.each(function() {
                const fileName = $(this).text();
                const data = $(this).data();
                fileList.push({ name: fileName, fileNo: data.fileNo});
            });

            console.log(fileList)
            // 파일 목록 그리기
            drawFileList();
        });


        // fileList 에 파일을 추가하고 다시 그리기
        function handleFileUpload() {
            console.log("업로드")

            const fileInput = document.getElementById('fileInput');

            // 파일이 선택되었는지 확인
            if (fileInput.files.length === 0) {
                alert('파일을 선택해주세요.');
                fileInput.value = null; // 파일 input 초기화
                return;
            }

            // 파일 추가 여부 및 최대 개수 확인
            if (fileList.length + fileInput.files.length > 5) {
                alert('최대 5개까지만 첨부 가능합니다.');
                fileInput.value = null; // 파일 input 초기화
                return;
            }

            // 파일 크기 확인
            for (var i = 0; i < fileInput.files.length; i++) {
                const fileSize = fileInput.files[i].size;
                const maxSize = 5 * 1024 * 1024; // 5MB

                if (fileSize > maxSize) {
                    alert('파일 크기는 최대 5MB까지만 허용됩니다.');
                    fileInput.value = null; // 파일 input 초기화
                    return;
                }
            }

            // fileList에 파일 추가
            for (var i = 0; i < fileInput.files.length; i++) {
                fileList.push(fileInput.files[i]);
            }

            // 파일 그리기
            drawFileList();

            console.log(fileList)
        }

        // fileList에 파일을 삭제하고 다시 그리기
        function removeFile(index) {
            console.log("삭제")

            //파일 제거
            if (index >= 0 && index < fileList.length) {
                //기존에 등록되어있던 파일은 deleteFile에 추가한다.
                if(fileList[index].fileNo != undefined){
                    console.log("fileNo----->",fileList[index].fileNo)
                    deleteFileIds.push(fileList[index].fileNo)
                }

                fileList.splice(index, 1);
            }

            console.log('deleteFiles=',deleteFileIds)

            //파일 그리기
            drawFileList();
        }

        // fileList를 참조하여 첨부 파일목록을 그린다.
        function drawFileList(){
            console.log("드로우")

            const fileDisplayContainer = document.querySelector('.qna-write-file-list');

            // 파일 목록을 싹 지우고 다시 그리기
            fileDisplayContainer.innerHTML = '';

            for (let i = 0; i < fileList.length; i++) {
                // 다시 그리기
                const fileNameDiv = document.createElement('div');
                fileNameDiv.innerHTML =
                    `<div class="qna-write-file-list-item">
                        <button type="button" onclick="removeFile(${i})">
                            <img src="/images/pc/btn_close.svg" alt="" />
                        </button>
                        <span>${fileList[i].name}</span>
                    </div>`;
                fileDisplayContainer.appendChild(fileNameDiv);
                // formData.append(`files[]`, fileInput.files[i]);
            }

            const fileInput = document.getElementById('fileInput');
            fileInput.value = null; // 파일 input 초기화
        }


        let deleteFileIds = [];

        // 기존 파일 삭제시
        function addDeleteList(button) {
            const fileNo = button.previousElementSibling.getAttribute("data-file-no");
            const fileElement = button.previousElementSibling;
            console.log("삭제할 파일 번호: " + fileNo);

            // 파일을 삭제할 때만 해당 파일 번호를 deleteFileIds에 추가
            if (fileElement.style.display !== "none") {
                fileElement.style.display = "none";
                button.style.display = "none";
                const index = deleteFileIds.indexOf(fileNo);
                if (index !== -1) {
                    deleteFileIds.splice(index, 1);
                }
            } else {
                const index = deleteFileIds.indexOf(fileNo);
                if (index === -1) {
                    deleteFileIds.push(fileNo);
                }
            }
        }

        // 기존 파일 삭제시 id 넘기기
        function getDeleteFileIds() {
            return deleteFileIds;
        }

        // 수정
        function editConfirm() {

            const title = $('#title').val();
            const content = $('#content').val();
            if (!title) {
                alert('제목을 입력해주세요.');
                return;
            }
            if (!content) {
                alert('내용을 입력해주세요.');
                return;
            }

            const paths = window.location.pathname.split('/');

            // const formData = new FormData();
            formData.append('email', $('#email').val());
            formData.append('emailReceiveYn', $('#emailReceiveYn').prop('checked') ? 'Y' : 'N');
            formData.append('title', title);
            formData.append('content', content);
            formData.append('memberId', $('#memberId').val());

            formData.append('qnaType1Cd', $('.qnaType1').find('select').val());
            formData.append('qnaType2Cd', $('.qnaType2').find('input:checked').val());

            const qnaRobots = [];
            const inquiryItems = $('.qna-write-inquiry-product-item');

            for (let i = 0; i < inquiryItems.length; i++) {
                const item = $(inquiryItems[i]);
                const modelCd = item.find('.robotModel select').val();
                const serialNo = item.find('.serialNo').val();
                let swVersion = '';
                const vValues = [];

                if(!serialNo) {
                    alert("로봇암 시리얼넘버를 입력해주세요.");
                    return;
                }

                for (let j = 1; j <= 10; j++) {
                    const v = item.find(`#software${j}`).val();
                    vValues.push(v);

                    if (vValues.some(value => value === '')) {
                        alert("소프트웨어 버전을 정확히 입력해주세요.");
                        return;
                    } else {
                        swVersion = vValues[0] + "." + vValues[1] + vValues[2] + vValues[3] + "." + vValues[4] + vValues[5] + vValues[6] + "." + vValues[7] + vValues[8] + vValues[9];
                    }
                }

                const applicationCd = item.find('.applicationCd select').val();

                const robotInfo = {
                    modelCd: modelCd,
                    serialNo: serialNo,
                    swVersion: swVersion,
                    applicationCd: applicationCd
                };
                qnaRobots.push(robotInfo);
            }

            for (let i = 0; i < qnaRobots.length; i++) {
                formData.append(`qnaRobots[${i}].modelCd`, qnaRobots[i].modelCd);
                formData.append(`qnaRobots[${i}].serialNo`, qnaRobots[i].serialNo);
                formData.append(`qnaRobots[${i}].swVersion`, qnaRobots[i].swVersion);
                formData.append(`qnaRobots[${i}].applicationCd`, qnaRobots[i].applicationCd);
            }


            // 삭제하는 파일
            const deleteFileIds = getDeleteFileIds();
            for (let i = 0; i < deleteFileIds.length; i++) {
                formData.append('deleteFileIds[]', deleteFileIds[i]);
            }


            // FIXME: files 는 새로 추가한 파일만 files 형태로 넘어가고 기존 파일은 넘기지 않는다.
            // 새로 추가된 파일
            // files를 초기화
            // formData.delete('files');
            //
            // fileList를 formData에 추가
            for (let i = 0; i < fileList.length; i++) {
                if(!fileList[i].fileNo){
                    formData.append('files', fileList[i]);
                    console.log("추가한 파일", fileList[i])
                }
            }


            COMM.ajax({
                type: 'PUT',
                url: '/qna/edit/' + paths[paths.length-1],
                data: formData,
                contentType: false,
                processData: false,
                success: function () {
                    alert("게시글이 정상적으로 수정되었습니다.");
                    window.location.href = '/qna/' + paths[paths.length-1];
                },
                error: function (xhr, textStatus) {
                    alert("수정에 실패하였습니다.");
                    console.error('Error:', xhr.responseText);
                    console.error('Status:', xhr.status);
                }
            });
        }



    </script>


</th:block>
</html>