<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/sub_layout.html}">
<body>
<div layout:fragment="content">

    <main class="sub notice-view">
        <div class="board board-type1">
            <div class="column">
                <h1>Q&A</h1>
                <!-- <p class="desc">
                  한화로보틱스 제품과<br />서비스 업데이트 소식을<br />알려드립니다.
                </p> -->
<!--                <p class="desc" th:utext="#{notice}">-->
            </div>

            <div class="column">
                <div class="board_title"></div>
                <div class="board_date"></div>
                <div class="board_contents"></div>





                <div>
                    <label>
                        답변 입력
                        <input id="replyContent" type="text">
                    </label>
                    <button onclick="register()">등록 </button>
                </div>



                <div class="reply"></div>



                <script id="reply-html" type="text/template">
                    {{#list}}
                    <div class="reply-item">
                        <p>{{replyContent}}</p>
                        <p>{{replyType}}</p>
                        <p>{{createDt}}</p>
                    </div>
                    {{/list}}
                </script>




                <div class="board_prev">
                    <!-- <a href="javascript:void(0)" onClick="goBack()">
                      목록으로
                    </a> -->
                    <a href="javascript:void(0)" onClick="goBack()" th:utext="#{toList}"></a>
                </div>
            </div>
        </div>








    </main>
</div>

</body>

<th:block layout:fragment="script">
    <script>
        $(document).ready(function () {
            getData();
        });

        function goBack(){
            var params = {};
            window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi,
                function(str, key, value) {
                    params[key] = value;
                }
            );
            if(params["to"] !== undefined && params["to"]==="main"){
                // location.href="/newsroom/notice";
            }else{
                history.back();
            }
        }

        const paths = window.location.pathname.split('/');

        function getData(){
            // var paths = window.location.pathname.split('/')

            COMM.ajax({
                url : "/qna/" + paths[paths.length-1],
                success : function(data) {
                    if(data.code === 200){
                        console.log(data)
                        if(data.data == null){
                            alert("[[#{alert.postNotExist}]]");
                            window.history.back();
                        }else{
                            $('.board_title').html(data.data.qnaDetail.title);
                            $('.board_date').html(data.data.qnaDetail.createDt.replaceAll('-','.'));
                            $('.board_contents').html(data.data.qnaDetail.content);

                            if(data.data.qnaReplies != null && data.data.qnaReplies.length > 0){
                                var template = $("#reply-html").html();
                                var rendered = Mustache.render(template, {'list' : data.data.qnaReplies});
                                $('.reply').html(rendered);
                            }



                            // var userMemberNo = ;
                            // var qnaAuthorMemberNo = data.data.qnaDetail.memberNo;
                            //
                            // if (userMemberNo !== qnaAuthorMemberNo) {
                            //     $('#replyContent').prop('disabled', true);
                            // }




                        }
                    }
                },
                error : function(jqXHR, textStatus, errorThrown){
                    console.log(jqXHR.status, jqXHR);
                }
            });
        }




        function register() {
            const replyContent = $('#replyContent').val();
            const qnaNo = paths[paths.length - 1];
            const jsonData = {
                replyContent: replyContent,
                qnaNo : qnaNo
            };

            $.ajax({
                type: 'POST',
                url: '/qna/reply',
                data: JSON.stringify(jsonData),
                contentType: 'application/json',
                success: function (data) {
                    alert('등록되었습니다.')
                    $('#replyContent').val('');
                    getData();
                },

                error: function (xhr, textStatus) {
                    console.error('전송 실패:', textStatus);
                    if (xhr.responseJSON) {
                        const errorMessage = xhr.responseJSON.message;
                        alert(errorMessage);
                    } else {
                        alert('등록에 실패했습니다.');
                    }
                }
            });

        }







    </script>
</th:block>
</html>