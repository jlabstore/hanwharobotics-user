<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/sub_layout.html}">
<body>
<div layout:fragment="content">

    <main class="sub qna-write">
        <div class="board board-type1">
            <div class="column">
                <h1>Q<span>&</span>A</h1>
                <p class="desc">
                    한화로보틱스에 대해 궁금한 점이<br />있으시면 문의해주세요.
                </p>
            </div>


            <div class="column board_list">
                <div class="qna-write-form">
                    <div class="qna-write-form-section">
                        <span class="qna-write-form-section-title">작성자</span>
<!--                        <input id="memberId" th:value="${memberResponse.getMemberId()}" readonly>-->
                        <div class="qna-write-form-section-content">
                            <input class="qna-write-default-input" type="text" name="name" id="memberId" th:value="${memberResponse.getMemberId()}" readonly/>
                        </div>
                    </div>

                    <div class="qna-write-form-section">
                        <span class="qna-write-form-section-title">이메일</span>
                        <div class="qna-write-form-section-content">
                            <input class="qna-write-custom-input" type="text" placeholder="이메일을 작성해주세요." name="email" id="email" th:value="${memberResponse.getEmail()}" />
                            <div class="qna-write-email-check">
                                <label class="checkbox">
                                    <input type="checkbox" id="emailReceiveYn" name="emailReceiveYn" value="Y"/>
                                    <span></span>
                                    <p>관리자가 답변을 남기면 이메일로 알림을 받습니다.</p>
                                </label>
                            </div>
                        </div>
                    </div>

<!--                    <label for="email">이메일 </label><input id="email" name="email" type="text" th:value="${memberResponse.getEmail()}">-->
<!--                    <input type="checkbox" id="emailReceiveYn" name="emailReceiveYn" style="appearance: auto" value="Y"> 관리자가 답변을 남기면 이메일로 알림을 받습니다.-->
<!--                    -->
<!--                    -->




                    <div class="qna-write-form-section">
                        <span class="qna-write-form-section-title">문의유형<strong>*</strong></span>
                        <div class="qna-write-form-section-content" >

                            <span class="qnaType1" id="qnaType1"></span>

                        </div>
                    </div>


                    <div class="qna-write-form-section">
                        <span class="qna-write-form-section-title">문의유형 2<strong>*</strong></span>
                        <div class="qna-write-form-section-content">
<!--                            <div class="qna-write-custom-radio">-->

                                <div class="qna-write-custom-radio qnaType2" id="qnaType2"></div>

<!--                            </div>-->
                        </div>
                    </div>








                    <div class="qna-write-form-section">
                        <span class="qna-write-form-section-title">문의제품</span>
                        <div class="qna-write-inquiry-product">
                            <div class="qna-write-inquiry-product-title">
                                <p>모델명</p>
                                <p>로봇암 시리얼넘버</p>
                                <p>소프트웨어 버전</p>
                                <p>어플리케이션</p>
                                <p>추가/삭제</p>
                            </div>
                            <div class="qna-write-inquiry-product-box" >


                                <div class="qna-write-inquiry-product-item">

                                    <span id="modelCd" class="robotModel" style="width: calc(20%);">
                                    </span>
                                    <input class="qna-write-custom-input serialNo" type="text" value="" name="serial1" id="serial1" />
<!--                                    <input type="text" id="serialNo" class="serialNo" placeholder="로봇암 시리얼넘버">-->
                                    <input class="qna-write-custom-input swVersion" type="text" value="" name="software1" id="software1" />
<!--                                    <input type="text" id="swVersion" class="swVersion" placeholder="소프트웨어 버전">-->
<!--                                    <select class="qna-write-custom-select app" name="inquiry3" id="inquiry3">-->
<!--                                    </select>-->
                                    <span id="applicationCd" class="application" style="width: calc(24%);"></span>






                                    <div class="qna-write-inquiry-product-item-btn">
                                        <button type="button" class="qna-write-inquiry-product-item-add" onclick="addRobotInfo()">
                                            <img src="../images/pc/ic_plus2.svg" alt="" />
                                        </button>
                                        <button type="button" class="qna-write-inquiry-product-item-delete" onclick="removeRobotInfo()">
                                            <img src="../images/pc/ic_minus.svg" alt="" />
                                        </button>
                                    </div>
                                </div>



                            </div>
                        </div>
                    </div>








<!--                    문의제품-->
<!--                    모델명-->
<!--                    로봇암 시리얼넘버-->
<!--                    소프트웨어 버전-->
<!--                    어플리케이션-->
<!--                    <br>-->
<!--                    <div class="robotInfoContainer">-->
<!--                        <span id="modelCd" class="robotModel"></span>-->

<!--                        <input type="text" id="serialNo" class="serialNo" placeholder="로봇암 시리얼넘버">-->
<!--                        <input type="text" id="swVersion" class="swVersion" placeholder="소프트웨어 버전">-->

<!--                        <span id="applicationCd" class="application"></span>-->

<!--                        <button type="button" onclick="addRobotInfo()">+</button>-->
<!--                        <button type="button" onclick="removeRobotInfo()">-</button>-->
<!--                    </div>-->





                    <div class="qna-write-form-section">
                        <span class="qna-write-form-section-title">제목</span>
                        <div class="qna-write-form-section-content">
                            <input class="qna-write-custom-input full" type="text" name="title" id="title" />
                        </div>
                    </div>



                    <div class="qna-write-form-section">
                        <span class="qna-write-form-section-title">내용</span>
                        <div class="qna-write-des-box">
                            <textarea class="qna-write-custom-textarea" name="description" id="content"></textarea>
                            <span>문의 내용에 따라 제품 로그, 제품 구동 영상, <strong>VOC 리포트</strong> 등을 추가로 요청할 수 있으며 메일을 통해 전달 부탁드립니다.</span>
                        </div>
                    </div>



<!--                    <label for="content">내용 </label><input id="content" name="content" type="text">-->










                    <div class="qna-write-form-section">
                        <span class="qna-write-form-section-title">첨부파일</span>
                        <div class="qna-write-form-file-wrapper">

                            <div class="qna-write-custom-file">
                                <input type="file" name="file" id="fileInput" onchange="handleFileUpload()"/>
                                <label for="fileInput">파일찾기</label>
                            </div>


                            <div class="qna-write-file-list">
                                <div class="qna-write-file-list-item">

                                </div>
                            </div>

                            <span>첨부파일 개당 최대 5MB 이내, 최대 5개까지 첨부 가능합니다. exe, html 형식등 문제가 될 수 있는 파일은 압축파일 형태로 첨부해주세요.</span>
                        </div>
                    </div>






                </div>


                <button type="button" class="qna-write-submit" onclick="register()">문의글 남기기</button>


            </div>
        </div>
    </main>
</div>

</body>

<th:block layout:fragment="script">
    <script>


        $(document).ready(function () {
            getCode();

            const emailReceiveYn = $('#emailReceiveYn').val();
            if (emailReceiveYn === 'Y') {
                $('#emailReceiveYn').prop('checked', true);
            }
        });

        // 코드 가져오기
        function getCode() {
            COMM.ajax({
                type: 'GET',
                url: "/qna/code",
                success: function (data) {
                    populateSelectBox(data.data.qnaType1List, 'qnaType1');
                    populateRadioButtons(data.data.qnaType2List, 'qnaType2');

                    populateSelectAndInputs(data.data.robotModelList, 'robotModel');
                    populateSelectAndInputsApp(data.data.applicationList, 'application');
                },
            });
        }

        // 문의유형1
        function populateSelectBox(options, selectClass) {
            const selectBox = $('<select class="qna-write-custom-select">');
            selectBox.addClass(selectClass);


            $.each(options, function (index, option) {
                selectBox.append($('<option>', {
                    value: option.code,
                    text: option.description
                }));
            });

            $('.' + selectClass).html(selectBox);
        }



        // 문의유형2
        function populateRadioButtons(options, containerId) {
            const container = $('#' + containerId);
            container.empty();

            $.each(options, function (index, option) {

                const label = $('<label>', {
                    class: 'radio'
                })
                const radioBtn = $('<input>', {
                    type: 'radio',
                    name: 'qnaType2',
                    value: option.code
                });

                const span = $('<span>',{
                });

                const p = $('<p>', {
                    // for: option.code,
                    text: option.description
                });

                label.append(radioBtn).append(span).append(p);
                container.append(label);
            });
        }







        // 문의제품 - 모델명
        function populateSelectAndInputs(options, containerId) {
            const container = $('.' + containerId);
            container.empty();

            const selectBox = $('<select class="qna-write-custom-select" name="inquiry2" id="inquiry2" style="width: 100%">');
            container.append(selectBox);

            selectBox.append($('<option>', {
                value: '',
                text: '선택'
            }));

            $.each(options, function (index, option) {
                selectBox.append($('<option>', {
                    value: option.code,
                    text: option.description
                }));
            });
        }


        // 문의제품 - 어플리케이션
        function populateSelectAndInputsApp(options, containerId) {
            const container = $('.' + containerId);
            container.empty();

            const selectBox = $('<select class="qna-write-custom-select app" name="inquiry3" id="inquiry3" style="width: 100%">');
            container.append(selectBox);

            selectBox.append($('<option>', {
                value: '',
                text: '선택'
            }));

            $.each(options, function (index, option) {
                selectBox.append($('<option>', {
                    value: option.code,
                    text: option.description
                }));
            });
        }


        const formData = new FormData();

        let robotInfoCounter = 1;

        function addRobotInfo() {
            if (robotInfoCounter < 10) {
                const newRobotInfo = $('.qna-write-inquiry-product-item:first').clone();
                newRobotInfo.find('input').val('');
                $('.qna-write-inquiry-product-item:last').after(newRobotInfo);
                robotInfoCounter++;
            }
        }


        function removeRobotInfo() {
            if (robotInfoCounter > 1) {
                $('.qna-write-inquiry-product-item:last').remove();
                robotInfoCounter--;
            }
        }







        // 파일
        // function handleFileUpload() {
        //     const fileInput = document.getElementById('fileInput');
        //     const fileDisplayContainer = document.querySelector('.qna-write-file-list-item');
        //     const currentFileCount = formData.getAll('files[]').length;
        //
        //     const additionalFileCount = fileInput.files.length;
        //
        //     if (currentFileCount + additionalFileCount > 5) {
        //         alert('최대 5개까지만 첨부 가능합니다.');
        //         fileInput.value = '';
        //         return;
        //     }
        //
        //     if (additionalFileCount > 0) {
        //         for (let i = 0; i < additionalFileCount; i++) {
        //             const fileNameDiv = document.createElement('div');
        //             fileNameDiv.innerHTML = `<button onclick="removeFile(${i})"><img src="../images/pc/btn_close.svg" alt="" /></button> ${fileInput.files[i].name} `;
        //             fileDisplayContainer.appendChild(fileNameDiv);
        //             formData.append(`files[]`, fileInput.files[i]);
        //         }
        //     }
        // }


        // 파일 삭제
        // function removeFile(index) {
        //     const fileDisplayContainer = document.querySelector('.qna-write-file-list-item');
        //     fileDisplayContainer.removeChild(fileDisplayContainer.childNodes[index]);
        //
        //     const fileInput = document.getElementById('fileInput');
        //     const files = Array.from(fileInput.files).filter((file, i) => i !== index);
        //     fileInput.value = '';
        //     files.forEach(file => {
        //         fileInput.files.append(file);
        //     });
        // }





        // 파일 업로드
        function handleFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const fileDisplayContainer = document.querySelector('.qna-write-file-list');
            const currentFileCount = formData.getAll('files[]').length;
            const additionalFileCount = fileInput.files.length;

            if (currentFileCount + additionalFileCount > 5) {
                alert('최대 5개까지만 첨부 가능합니다.');
                fileInput.value = '';
                return;
            }

            if (additionalFileCount > 0) {
                for (let i = 0; i < additionalFileCount; i++) {
                    const fileNameDiv = document.createElement('div');
                    fileNameDiv.innerHTML = `<div class="qna-write-file-list-item"><button type="button" onclick="removeFile(${currentFileCount + i})"><img src="../images/pc/btn_close.svg" alt="" /></button> <span>${fileInput.files[i].name}</span></div> `;

                    console.log("확인"+currentFileCount + i)

                    fileDisplayContainer.appendChild(fileNameDiv);
                    formData.append(`files[]`, fileInput.files[i]);
                }
            }
        }


        // 파일 삭제
        function removeFile(index) {
            const fileDisplayContainer = document.querySelector('.qna-write-file-list');
            fileDisplayContainer.removeChild(fileDisplayContainer.childNodes[index]);


            const fileInput = document.getElementById('fileInput');
            const files = Array.from(fileInput.files);

            files.splice(index, 1);
            fileInput.value = '';

            formData.delete(`files[]`);

            files.forEach((file) => {
                formData.append(`files[]`, file);
            });
        }
















        // 등록
        function register() {

            const qnaType2Selected = $('.qnaType2 input:checked').length > 0;
            if (!qnaType2Selected) {
                alert('문의 유형을 선택해주세요.');
                return;
            }

            // const formData = new FormData();
            formData.append('email', $('#email').val());
            formData.append('emailReceiveYn', $('#emailReceiveYn').prop('checked') ? 'Y' : 'N');
            formData.append('title', $('#title').val());
            formData.append('content', $('#content').val());
            formData.append('memberId', $('#memberId').val());

            formData.append('qnaType1Cd', $('.qnaType1').find('select').val());
            formData.append('qnaType2Cd', $('.qnaType2').find('input:checked').val());

            const qnaRobots = [];
            $('.qna-write-inquiry-product-item').each(function () {
                const modelCd = $(this).find('.robotModel select').val();
                const serialNo = $(this).find('.serialNo').val();
                const swVersion = $(this).find('.swVersion').val();
                const applicationCd = $(this).find('.application select').val();

                const robotInfo = {
                    modelCd: modelCd,
                    serialNo: serialNo,
                    swVersion: swVersion,
                    applicationCd: applicationCd
                };
                qnaRobots.push(robotInfo);
            });

            for (let i = 0; i < qnaRobots.length; i++) {
                formData.append(`qnaRobots[${i}].modelCd`, qnaRobots[i].modelCd);
                formData.append(`qnaRobots[${i}].serialNo`, qnaRobots[i].serialNo);
                formData.append(`qnaRobots[${i}].swVersion`, qnaRobots[i].swVersion);
                formData.append(`qnaRobots[${i}].applicationCd`, qnaRobots[i].applicationCd);
            }

            const fileInput = document.getElementById('fileInput');
            for (let i = 0; i < fileInput.files.length; i++) {
                formData.append(`files[${i}]`, fileInput.files[i]);
            }

            $.ajax({
                type: 'POST',
                url: '/qna/register',
                data: formData,
                contentType: false,
                processData: false,
                success: function (data) {
                    alert("게시글이 정상적으로 등록되었습니다.");
                    window.location.href = '/qna/' + data;
                },
                error: function (xhr, textStatus) {
                    alert("등록에 실패하였습니다.");
                    console.error('Error:', xhr.responseText);
                    console.error('Status:', xhr.status);
                }
            });
        }




    </script>




</th:block>

</html>