<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/sub_layout.html}">
<body>

<div layout:fragment="content">

    <div>
        <br><br><br><br><br><br><br><br><br><br>
        <h1>마이페이지</h1>
        <h1>회원정보 수정</h1>
        <hr>

        아이디 <span th:text="${memberResponse.getMemberId()}"/>

        <br><br>

        비밀번호 변경 <button id="openModalBtn"> 비밀번호 변경 </button>
        <br><br>



        <!-- 비밀번호 변경 모달 -->
        <div id="passwordChange" class="popup">
            <span class="close">&times;</span>
            <h2>비밀번호 변경</h2>
            <div id="passwordForm">
                비밀번호를 변경하기 위해 기존 비밀번호를 먼저 입력해주세요.<br>
                <label for="password">기존 비밀번호</label>
                <input type="password" id="password" name="password"><br><br>
                <button type="button" onclick="checkPasswordChange()">확인</button>
            </div>
        </div>

        <div id="passwordChange2" class="popup">
            <span class="close">&times;</span>
            <h2>비밀번호 변경</h2>
            <div id="passwordForm2">
                새로운 비밀번호를 입력해주세요.<br>
                <label for="newPassword1">비밀번호</label>
                <input type="password" id="newPassword1" name="newPassword1"><br>
                영문과 숫자를 조합하여 만들어주세요.<br>
                <label for="newPassword2">비밀번호 다시입력</label>
                <input type="password" id="newPassword2" name="newPassword2"><br><br>
                <button type="button" onclick="changePassword()">비밀번호 변경</button>
            </div>
        </div>


        <div id="passwordChange3" class="popup">
            <span class="close">&times;</span>
            <h2>비밀번호 변경</h2>
            <div id="passwordForm3">
                비밀번호 변경이 완료되었습니다.<br>
                <span class="close">확인</span>
            </div>
        </div>







        <label for="email_front">이메일 주소 *</label>
        <input type="text" id="email_front" name="email_front" th:value="${#strings.substringBefore(memberResponse.getEmail(), '@')}" required>
        <label>
            @
            <select id="email_end" name="email_end">
                <option value="gmail.com">gmail.com</option>
                <option value="naver.com">naver.com</option>
                <option value="hotmail.com">hotmail.com</option>
                <option value="nate.com">nate.com</option>
                <option value="kakao.com">kakao.com</option>
<!--                <option value="">직접입력</option>-->
            </select>
        </label>
        <input id="email" name="email" style="display: none">

        <button type="button" onclick="checkDuplicateEmail()">중복확인</button>

        <!--                <input type="text" id="custom_email" name="custom_email" style="display: none;" placeholder="이메일인풋창">-->
        <br>
        <span id="email_check" class="check_text" style="color: #ff0000;"></span>
        <br><br>



        <label for="companyName">업체명 * </label><input type="text" th:value="${memberResponse.getCompanyNm()}" id="companyName" name="companyName">
        <br><br>





        <div th:if="${memberResponse.getRegion()} != 'KR'" >
<!--                <label for="selectCountry">Country/Region * </label>-->

<!--                <select id="selectCountry">-->
<!--                    <option th:each="country : ${countries}" th:value="${country['code']}" th:text="${country['code_en']}"></option>-->
<!--                </select>-->

            Country/Region
            <input th:value="${memberResponse.getRegion()}"/>



            <br>
            <label for="city">City * </label><input type="text" id="city" name="city" th:value="${memberResponse.getCity()}" >




        </div>
        <br><br>


        <div>

            <label for="postcode">우편번호 *</label><input type="text" id="postcode" name="postcode" th:value="${memberResponse.getPostCd()}">

            <span th:if="${memberResponse.getRegion()} == 'KR'">
                <button type="button" onclick="daumPostcode()">우편번호 찾기</button>
            </span>

            <br>

            <label for="address">주소 *</label><input type="text" id="address" name="address" th:value="${memberResponse.getAddress()}">
            <br>

            <label for="addressDetail">상세주소 *</label><input type="text" id="addressDetail" name="addressDetail" th:value="${memberResponse.getAddressDetail()}">
        </div>
        <br><br>


        <label for="store">로봇 구매처 / 대리점 * </label><input type="text" id="store" name="store" th:value="${memberResponse.getStore()}" required>
        <br><br>

        <label for="memberNm">이름 * </label><input type="text" id="memberNm" name="memberNm" th:value="${memberResponse.getMemberNm()}" required>
        <br><br>

        <label for="position">직급 * </label><input type="text" id="position" name="position" th:value="${memberResponse.getPosition()}" required>
        <br><br>



        <label>
            연락처 *

            <span th:with="contactParts=${#strings.setSplit(memberResponse.getContact(), ')')}">

                <select id="phone_code" required>
                    <option th:each="phoneCode : ${phoneCodes}"
                            th:value="${phoneCode['code_phone']}"
                            th:selected="${phoneCode['code_phone'] == contactParts[0]}"
                            th:text="${phoneCode['code_phone']}">
                    </option>
                </select>

                <input id="phone" name="phone" th:value="${contactParts[1]}" required>

            </span>
            <input id="contact" name="contact" style="display: none">

        </label>



        <br><br><br><br>

        <hr>

        <button type="button" onclick="editConfirm()">수정완료</button>




    </div>


</div>


</body>
</html>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script th:inline="javascript">

    $(document).ready(function() {
        updateEmailField();
        updatePhoneField();
        $("#email_front, #email_end").on("change", updateEmailField);
        $("#phone_code, #phone").on("change", updatePhoneField);

    });

    // 이메일 중복확인
    function checkDuplicateEmail() {
        const email_front = $("#email_front").val();
        const email = $('#email').val();
        const emailCheckElement = $('#email_check');

        if (email_front.length < 3 ) {
            emailCheckElement.text("이메일을 정확히 입력해 주세요");
        } else {
            $.ajax({
                type: 'GET',
                url: `/check/email?email=${encodeURIComponent(email)}`,
                success: function(data) {
                    if (data === true) {
                        emailCheckElement.text("이미 존재하는 이메일입니다.");
                    } else {
                        emailCheckElement.text("사용 가능한 이메일 입니다.");
                    }
                },
                error: function() {
                    alert('서버 에러');
                }
            });
        }
    }



    // 우편번호 검색
    function daumPostcode() {
        new daum.Postcode({
            oncomplete: function (data) {
                let addr = '';
                if (data.userSelectedType === 'R') { // 도로명 주소
                    addr = data.roadAddress;
                } else { // 지번 주소
                    addr = data.jibunAddress;
                }
                document.getElementById('postcode').value = data.zonecode;
                document.getElementById("address").value = addr;
                document.getElementById("addressDetail").focus();
            }
        }).open();
    }


    // 연락처 숫자만 입력
    document.getElementById('phone').addEventListener('keyup', function() {
        checkNumericInput(this);
    });

    function checkNumericInput(inputElement) {
        const inputValue = inputElement.value;
        if (!/^[0-9]*$/.test(inputValue)) {
            inputElement.value = inputValue.replace(/[^0-9]/g, '');
        }
    }

    // 수정완료 버튼
    function editConfirm(){
        const email_front = $("#email_front").val();
        const email_end = $("#email_end").val();
        const email = email_front + "@" + email_end;

        const phone_code = $("#phone_code").val();
        const phone = $("#phone").val();
        const contact = phone_code + ")" + phone;

        const temp = {
            memberId: $('#memberId').val(),
            password: $('#password').val(),
            companyNm: $('#companyName').val(),
            region: $('#region').val(),
            city: $('#city').val(),
            postCd: $('#postcode').val(),
            address: $('#address').val(),
            addressDetail: $('#addressDetail').val(),
            store: $('#store').val(),
            memberNm: $('#memberNm').val(),
            position: $('#position').val(),
            email: email,
            contact: contact,
        };

        COMM.ajax({
            url : "/member/profile/edit",
            type: "PUT",
            headers: {'Content-Type': 'application/json'},
            data: JSON.stringify(temp),
            success : function(data) {
                if(data.code === 200){
                    window.location.href="/member/profile";
                }
            },
            error : function(jqXHR){
                console.log(jqXHR.status, jqXHR);
            },
        });

    }


    // 비밀번호 변경 모달
    document.getElementById('openModalBtn').addEventListener('click', function() {
        document.getElementById('passwordChange').style.display = 'block';
    });

    // 비밀번호 일치 체크
    function checkPasswordChange() {
        const password = $("#password").val();
        const requestData = {
            password: password
        };

        COMM.ajax({
            url : "/member/check/password",
            type: "POST",
            headers: {'Content-Type': 'application/json'},
            data: JSON.stringify(requestData),
            success : function(data) {
                if(data.code === 200){
                    document.getElementById('passwordChange2').style.display = 'block';
                }
            },
            error : function(jqXHR){
                const errorResponse = JSON.parse(jqXHR.responseText);
                alert(errorResponse.message);
                console.log(jqXHR.status, jqXHR);
            },
        });

    }

    // 모달 닫기 버튼
    document.querySelectorAll('.close').forEach(function(closeButton) {
        closeButton.addEventListener('click', function() {
            this.closest('.popup').style.display = 'none';
        });
    });

    // 비밀번호 변경
    function changePassword() {

        const newPassword = $("#newPassword1").val();
        const requestData = {
            newPassword: newPassword
        };

        COMM.ajax({
            url : "/member/change/password",
            type: "PUT",
            headers: {'Content-Type': 'application/json'},
            data: JSON.stringify(requestData),
            success : function(data) {
                if(data.code === 200){

                }
            },
            error : function(jqXHR){
                const errorResponse = JSON.parse(jqXHR.responseText);
                alert(errorResponse.message);
                console.log(jqXHR.status, jqXHR);
            },
        });





    }



</script>

<style>
    .popup {
        position: absolute;
        z-index: 1;
        background-color: #ffffff;
        border: 1px solid #ddd;
        padding: 20px;
        display: none;
    }
</style>
